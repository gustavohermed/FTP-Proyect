---
- name: FTP and FTPS Server Configuration with vsftpd
  hosts: all
  become: yes

  vars:
    ftp_users:
      - luis
      - maria
      - miguel
    ftp_password: "{{ 'SecurePass123' | password_hash('sha512') }}"

  tasks:

  # ==========================================================
  # 1. Install required packages
  # ==========================================================
  - name: Install vsftpd and openssl
    apt:
      name:
        - vsftpd
        - openssl
      state: present
      update_cache: yes

  # ==========================================================
  # 2. Create local FTP users
  # ==========================================================
  - name: Create local users
    user:
      name: "{{ item }}"
      password: "{{ ftp_password }}"
      shell: /bin/bash
      create_home: yes
    loop: "{{ ftp_users }}"

  # ==========================================================
  # 3. Create test files for users
  # ==========================================================
  - name: Create test files for luis
    become_user: luis
    shell: |
      touch ~/luis1.txt ~/luis2.txt

  - name: Create test files for maria
    become_user: maria
    shell: |
      touch ~/maria1.txt ~/maria2.txt

  # ==========================================================
  # 4. Backup original vsftpd configuration
  # ==========================================================
  - name: Backup vsftpd.conf
    copy:
      src: /etc/vsftpd.conf
      dest: /etc/vsftpd.conf.bak
      remote_src: yes
      force: no

  # ==========================================================
  # 5. Generate SSL private key
  # ==========================================================
  - name: Generate SSL private key
    command: openssl genrsa -out /etc/ssl/private/example.test.key 2048
    args:
      creates: /etc/ssl/private/example.test.key

  # ==========================================================
  # 6. Generate self-signed SSL certificate
  # ==========================================================
  - name: Generate SSL certificate
    command: >
      openssl req -x509 -nodes -days 365
      -key /etc/ssl/private/example.test.key
      -out /etc/ssl/certs/example.test.pem
      -subj "/CN=ftp.example.test"
    args:
      creates: /etc/ssl/certs/example.test.pem

  # ==========================================================
  # 7. Configure vsftpd (FTP + FTPS)
  # ==========================================================
  - name: Configure vsftpd service
    copy:
      dest: /etc/vsftpd.conf
      content: |
        #
        # 1. Standalone mode using IPv4
        #
        listen=YES
        listen_ipv6=NO

        #
        # 2. Welcome banner
        #
        ftpd_banner=--- Welcome to the FTP server of 'sistema.sol'---

        #
        # 3. Anonymous access configuration
        #
        anonymous_enable=YES
        anon_root=/srv/ftp
        anon_world_readable_only=YES
        anon_upload_enable=NO
        anon_mkdir_write_enable=NO
        anon_other_write_enable=NO
        no_anon_password=YES

        #
        # 4. Local users configuration
        #
        local_enable=YES
        write_enable=YES

        #
        # 5. Chroot configuration
        #
        chroot_local_user=YES
        chroot_list_enable=YES
        chroot_list_file=/etc/vsftpd.chroot_list

        #
        # 6. Connection limits
        #
        idle_session_timeout=720
        max_clients=15

        #
        # 7. Bandwidth limits
        #
        local_max_rate=5242880
        anon_max_rate=2097152

        #
        # 8. Active FTP data port
        #
        connect_from_port_20=YES

        #
        # 9. FTPS configuration
        #
        ssl_enable=YES
        allow_anon_ssl=YES
        force_local_logins_ssl=YES
        force_local_data_ssl=YES

        ssl_tlsv1=YES
        ssl_sslv3=YES

        rsa_cert_file=/etc/ssl/certs/example.test.pem
        rsa_private_key_file=/etc/ssl/private/example.test.key

        #
        # 10. Compatibility
        #
        require_ssl_reuse=NO
    notify: restart vsftpd

  # ==========================================================
  # 8. Chroot exception (only maria)
  # ==========================================================
  - name: Configure chroot exception list
    copy:
      dest: /etc/vsftpd.chroot_list
      content: maria

  # ==========================================================
  # 9. Anonymous access message
  # ==========================================================
  - name: Configure anonymous welcome message
    copy:
      dest: /srv/ftp/.message
      content: |
        ---You have accessed the public directory server of 'sistema.sol'---

  # ==========================================================
  # 10. Ensure vsftpd is running
  # ==========================================================
  - name: Ensure vsftpd service is running
    systemd:
      name: vsftpd
      state: restarted
      enabled: yes

  handlers:
    - name: restart vsftpd
      systemd:
        name: vsftpd
        state: restarted
