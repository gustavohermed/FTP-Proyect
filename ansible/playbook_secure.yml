---
- name: Punto 6 - ConfiguraciÃ³n FTP Seguro (FTPS)
  hosts: all
  become: yes

  tasks:

  # ==========================================================
  # 1. Install required packages
  # ==========================================================
  - name: Install vsftpd and openssl
    apt:
      name:
        - vsftpd
        - openssl
      state: present
      update_cache: yes

  # ==========================================================
  # 2. Generate SSL private key
  # ==========================================================
  - name: Generate private key
    command: openssl genrsa -out /etc/ssl/private/example.test.key 2048
    args:
      creates: /etc/ssl/private/example.test.key

  # ==========================================================
  # 3. Generate self-signed certificate
  # ==========================================================
  - name: Generate SSL certificate
    command: >
      openssl req -x509 -nodes -days 365
      -key /etc/ssl/private/example.test.key
      -out /etc/ssl/certs/example.test.pem
      -subj "/CN=ftp.example.test"
    args:
      creates: /etc/ssl/certs/example.test.pem

  # ==========================================================
  # 4. Configure vsftpd for FTPS
  # ==========================================================
  - name: Configure vsftpd FTPS
    copy:
      dest: /etc/vsftpd.conf
      content: |
        #
        # 1. Standalone mode using IPv4
        #
        listen=YES
        listen_ipv6=NO

        #
        # 2. Welcome banner
        #
        ftpd_banner=--- Welcome to the FTP server of 'sistema.sol'---

        #
        # 3. Anonymous users
        #
        anonymous_enable=YES
        no_anon_password=YES
        anon_root=/srv/ftp
        anon_upload_enable=NO
        anon_mkdir_write_enable=NO
        anon_other_write_enable=NO

        #
        # 4. Local users
        #
        local_enable=YES
        write_enable=YES

        #
        # 5. Chroot configuration
        #
        chroot_local_user=YES
        chroot_list_enable=YES
        chroot_list_file=/etc/vsftpd.chroot_list

        #
        # 6. Limits
        #
        max_clients=15
        idle_session_timeout=720

        #
        # 7. Bandwidth limits
        #
        local_max_rate=5242880
        anon_max_rate=2097152

        #
        # 8. Active FTP
        #
        connect_from_port_20=YES

        #
        # 9. FTPS configuration
        #
        ssl_enable=YES
        allow_anon_ssl=YES
        force_local_logins_ssl=YES
        force_local_data_ssl=YES

        ssl_tlsv1=YES
        ssl_sslv3=YES

        rsa_cert_file=/etc/ssl/certs/example.test.pem
        rsa_private_key_file=/etc/ssl/private/example.test.key

        #
        # 10. Compatibility
        #
        require_ssl_reuse=NO
    notify: restart vsftpd

  # ==========================================================
  # 5. Chroot exception
  # ==========================================================
  - name: Configure chroot exception for maria
    copy:
      dest: /etc/vsftpd.chroot_list
      content: maria

  # ==========================================================
  # 6. Ensure vsftpd running
  # ==========================================================
  - name: Ensure vsftpd is running
    systemd:
      name: vsftpd
      state: restarted
      enabled: yes

  handlers:
    - name: restart vsftpd
      systemd:
        name: vsftpd
        state: restarted

