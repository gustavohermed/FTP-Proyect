---
- name: Punto 4 y 5 - Instalación y configuración de vsftpd
  hosts: all
  become: yes

  tasks:

  # ==========================================================
  # PUNTO 4 - INSTALACIÓN Y PREPARACIÓN DEL SERVIDOR FTP
  # ==========================================================

  # 1. Install vsftpd
  - name: Install vsftpd
    apt:
      name: vsftpd
      state: present
      update_cache: yes

  # 2. Ensure /srv/ftp directory exists with correct ownership
  - name: Ensure /srv/ftp directory permissions
    file:
      path: /srv/ftp
      state: directory
      owner: root
      group: ftp
      mode: '0755'

  # 3. Backup vsftpd configuration
  - name: Backup vsftpd.conf
    copy:
      src: /etc/vsftpd.conf
      dest: /etc/vsftpd.conf.bak
      remote_src: yes
      force: no

  # 4. Create local users with password
  - name: Create local users with password
    user:
      name: "{{ item }}"
      create_home: yes
      shell: /bin/bash
      password: "{{ 'ftp123' | password_hash('sha512') }}"
    loop:
      - luis
      - maria
      - miguel

  # 5. Create files for luis
  - name: Create files for luis
    copy:
      dest: "/home/luis/{{ item }}"
      content: "Archivo {{ item }}"
      owner: luis
      group: luis
    loop:
      - luis1.txt
      - luis2.txt

  # 6. Create files for maria
  - name: Create files for maria
    copy:
      dest: "/home/maria/{{ item }}"
      content: "Archivo {{ item }}"
      owner: maria
      group: maria
    loop:
      - maria1.txt
      - maria2.txt

  # ==========================================================
  # PUNTO 5 - CONFIGURACIÓN FTP
  # ==========================================================

  # 7. Configure vsftpd.conf (clean + commented)
  - name: Configure vsftpd according to requirements
    copy:
      dest: /etc/vsftpd.conf
      content: |
        #
        # 1. Standalone mode using IPv4
        #
        listen=YES
        listen_ipv6=NO

        #
        # 2. Welcome banner
        #
        ftpd_banner=--- Welcome to the FTP server of 'sistema.sol'---

        #
        # 3. Anonymous users configuration
        #
        anonymous_enable=YES
        no_anon_password=YES
        anon_root=/srv/ftp
        anon_upload_enable=NO
        anon_mkdir_write_enable=NO
        anon_other_write_enable=NO

        #
        # 4. Message for anonymous users
        #
        dirmessage_enable=YES
        message_file=.message

        #
        # 5. Local users configuration
        #
        local_enable=YES
        write_enable=YES

        #
        # 6. Chroot configuration
        #
        chroot_local_user=YES
        chroot_list_enable=YES
        chroot_list_file=/etc/vsftpd.chroot_list

        #
        # 7. Connection limits
        #
        max_clients=15
        idle_session_timeout=720

        #
        # 8. Bandwidth limits
        #
        local_max_rate=5242880
        anon_max_rate=2097152

        #
        # 9. Active FTP configuration
        #
        connect_from_port_20=YES

        #
        # 10. Logging
        #
        xferlog_enable=YES
    notify: restart vsftpd

  # 8. Create anonymous welcome message
  - name: Create anonymous welcome message
    copy:
      dest: /srv/ftp/.message
      content: |
        ---You have accessed the public directory server of 'sistema.sol'---
      owner: root
      group: ftp
      mode: '0644'

  # 9. Configure chroot exception for maria
  - name: Configure chroot exceptions
    copy:
      dest: /etc/vsftpd.chroot_list
      content: maria

  # 10. Ensure vsftpd is running
  - name: Ensure vsftpd is running
    systemd:
      name: vsftpd
      state: restarted
      enabled: yes

  handlers:
    - name: restart vsftpd
      systemd:
        name: vsftpd
        state: restarted
