---
- name: Secure FTP server configuration
  hosts: all
  become: yes

  tasks:

  # 1. Install vsftpd and openssl
  - name: Install required packages
    apt:
      name:
        - vsftpd
        - openssl
      state: present
      update_cache: yes

  # 2. Backup default configuration
  - name: Backup vsftpd configuration
    copy:
      src: /etc/vsftpd.conf
      dest: /etc/vsftpd.conf.bak
      remote_src: yes
      force: no

  # 3. Create local users
  # 3. Create local users with password
  - name: Create FTP users
    user:
      name: "{{ item }}"
      create_home: yes
      shell: /bin/bash
      password: "{{ 'ftp123' | password_hash('sha512') }}"
    loop:
      - luis
      - maria
      - miguel


  # 4. Create test files
  - name: Create files for luis
    copy:
      dest: "/home/luis/{{ item }}"
      content: "Archivo {{ item }}"
      owner: luis
      group: luis
    loop:
      - luis1.txt
      - luis2.txt

  - name: Create files for maria
    copy:
      dest: "/home/maria/{{ item }}"
      content: "Archivo {{ item }}"
      owner: maria
      group: maria
    loop:
      - maria1.txt
      - maria2.txt

  # 5. Generate SSL certificate
  - name: Generate private key
    command: openssl genrsa -out /etc/ssl/private/example.test.key 2048
    args:
      creates: /etc/ssl/private/example.test.key

  - name: Generate certificate
    command: >
      openssl req -x509 -nodes -days 365
      -key /etc/ssl/private/example.test.key
      -out /etc/ssl/certs/example.test.pem
      -subj "/CN=ftp.example.test"
    args:
      creates: /etc/ssl/certs/example.test.pem

  # 6. Configure vsftpd
  - name: Configure vsftpd
    copy:
      dest: /etc/vsftpd.conf
      content: |
        # Standalone IPv4
        listen=YES
        listen_ipv6=NO

        # Welcome message
        ftpd_banner=--- Welcome to the FTP server of 'sistema.sol'---

        # Anonymous users
        anonymous_enable=YES
        anon_upload_enable=NO
        anon_mkdir_write_enable=NO
        anon_other_write_enable=NO

        # Local users
        local_enable=YES
        write_enable=YES

        # Chroot
        chroot_local_user=YES
        chroot_list_enable=YES
        chroot_list_file=/etc/vsftpd.chroot_list

        # Limits
        max_clients=15
        idle_session_timeout=720

        # Bandwidth
        local_max_rate=5242880
        anon_max_rate=2097152

        # Active FTP
        connect_from_port_20=YES

        # FTPS configuration (compatible with FileZilla)
        ssl_enable=YES
        allow_anon_ssl=YES

        # Only login is forced to SSL
        force_local_logins_ssl=YES
        force_local_data_ssl=NO

        # TLS only
        ssl_tlsv1=YES
        ssl_sslv3=NO

        rsa_cert_file=/etc/ssl/certs/example.test.pem
        rsa_private_key_file=/etc/ssl/private/example.test.key

        # Required for many FTPS clients
        require_ssl_reuse=NO

    notify: restart vsftpd

  # 7. Chroot exception
  - name: Allow maria outside chroot
    copy:
      dest: /etc/vsftpd.chroot_list
      content: maria

  # 8. Ensure service running
  - name: Ensure vsftpd is running
    systemd:
      name: vsftpd
      state: started
      enabled: yes

  handlers:
    - name: restart vsftpd
      systemd:
        name: vsftpd
        state: restarted
